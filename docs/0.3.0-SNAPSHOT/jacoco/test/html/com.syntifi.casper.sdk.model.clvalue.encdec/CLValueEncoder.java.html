<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CLValueEncoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">casper-sdk</a> &gt; <a href="index.source.html" class="el_package">com.syntifi.casper.sdk.model.clvalue.encdec</a> &gt; <span class="el_source">CLValueEncoder.java</span></div><h1>CLValueEncoder.java</h1><pre class="source lang-java linenums">package com.syntifi.casper.sdk.model.clvalue.encdec;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectOutputStream;
import java.math.BigInteger;
import java.nio.ByteBuffer;
import java.util.Arrays;

import com.syntifi.casper.sdk.exception.CLValueEncodeException;
import com.syntifi.casper.sdk.exception.NoSuchTypeException;
import com.syntifi.casper.sdk.model.clvalue.AbstractCLValue;
import com.syntifi.casper.sdk.model.clvalue.CLValueAny;
import com.syntifi.casper.sdk.model.clvalue.CLValueBool;
import com.syntifi.casper.sdk.model.clvalue.CLValueByteArray;
import com.syntifi.casper.sdk.model.clvalue.CLValueI32;
import com.syntifi.casper.sdk.model.clvalue.CLValueI64;
import com.syntifi.casper.sdk.model.clvalue.CLValueKey;
import com.syntifi.casper.sdk.model.clvalue.CLValuePublicKey;
import com.syntifi.casper.sdk.model.clvalue.CLValueString;
import com.syntifi.casper.sdk.model.clvalue.CLValueU128;
import com.syntifi.casper.sdk.model.clvalue.CLValueU256;
import com.syntifi.casper.sdk.model.clvalue.CLValueU32;
import com.syntifi.casper.sdk.model.clvalue.CLValueU512;
import com.syntifi.casper.sdk.model.clvalue.CLValueU64;
import com.syntifi.casper.sdk.model.clvalue.CLValueU8;
import com.syntifi.casper.sdk.model.clvalue.cltype.CLTypeData;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Casper CLValue Encoding methods
 * 
 * @author Alexandre Carvalho
 * @author Andre Bertolace
 * @see AbstractCLValue
 * @since 0.0.1
 */

public class CLValueEncoder extends ByteArrayOutputStream {

<span class="fc" id="L43">    private static final Logger LOGGER = LoggerFactory.getLogger(CLValueEncoder.class);</span>

<span class="fc" id="L45">    public static final BigInteger ZERO = new BigInteger(&quot;0&quot;, 10);</span>
<span class="fc" id="L46">    public static final BigInteger ONE = new BigInteger(&quot;1&quot;, 10);</span>
<span class="fc" id="L47">    public static final BigInteger TWO = new BigInteger(&quot;2&quot;, 10);</span>
<span class="fc" id="L48">    public static final BigInteger MAX_U64 = TWO.pow(64).subtract(ONE);</span>
<span class="fc" id="L49">    public static final BigInteger MAX_U128 = TWO.pow(128).subtract(ONE);</span>
<span class="fc" id="L50">    public static final BigInteger MAX_U256 = TWO.pow(256).subtract(ONE);</span>
<span class="fc" id="L51">    public static final BigInteger MAX_U512 = TWO.pow(512).subtract(ONE);</span>

    private static final String LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING = &quot;Writing CLType {} from Java Type {}: {}&quot;;
    private static final String ENCODE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING = &quot;Value %s out of bounds for expected type %s&quot;;

    /**
     * Initializes buffer as zero-length
     */
    public CLValueEncoder() {
<span class="fc" id="L60">        super(0);</span>
<span class="fc" id="L61">    }</span>

    /**
     * Writes a boolean value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueBool} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeBool(CLValueBool clValue) throws IOException {
<span class="fc" id="L70">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.BOOL, Boolean.class.getSimpleName(),</span>
<span class="fc" id="L71">                clValue.getValue());</span>

<span class="fc" id="L73">        ByteBuffer boolByteBuffer = ByteBuffer.allocate(1)</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                .put(Boolean.TRUE.equals(clValue.getValue()) ? (byte) 0x01 : (byte) 0x00);</span>

<span class="fc" id="L76">        byte[] boolBytes = boolByteBuffer.array();</span>

<span class="fc" id="L78">        this.write(boolBytes);</span>

<span class="fc" id="L80">        clValue.setBytes(StringByteHelper.convertBytesToHex(boolBytes));</span>
<span class="fc" id="L81">    }</span>

    /**
     * Writes a single byte value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU8} value to encode
     */
    public void writeU8(CLValueU8 clValue) {
<span class="fc" id="L89">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.U8, Byte.class.getSimpleName(),</span>
<span class="fc" id="L90">                clValue.getValue());</span>

<span class="fc" id="L92">        this.write(clValue.getValue());</span>

<span class="fc" id="L94">        clValue.setBytes(StringByteHelper.convertBytesToHex(new byte[] {clValue.getValue()}));</span>
<span class="fc" id="L95">    }</span>

    /**
     * Writes a byte array value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueByteArray} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeByteArray(CLValueByteArray clValue) throws IOException {
<span class="fc" id="L104">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.BYTE_ARRAY, byte[].class.getSimpleName(),</span>
<span class="fc" id="L105">                clValue.getValue());</span>

<span class="fc" id="L107">        this.write(clValue.getValue());</span>

<span class="fc" id="L109">        clValue.getClType().setLength(clValue.getValue().length);</span>
<span class="fc" id="L110">        clValue.setBytes(StringByteHelper.convertBytesToHex(clValue.getValue()));</span>
<span class="fc" id="L111">    }</span>

    /**
     * Writes an Integer/I32 value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueI32} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeI32(CLValueI32 clValue) throws IOException {
<span class="fc" id="L120">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.I32, Integer.class.getSimpleName(),</span>
<span class="fc" id="L121">                clValue.getValue());</span>

<span class="fc" id="L123">        byte[] intByteArray = writeInt(clValue.getValue());</span>

<span class="fc" id="L125">        clValue.setBytes(StringByteHelper.convertBytesToHex(intByteArray));</span>
<span class="fc" id="L126">    }</span>

    /**
     * Writes an Unsigned Integer (Long)/U32 value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU32} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeU32(CLValueU32 clValue) throws IOException {
<span class="fc" id="L135">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.U32, Long.class.getSimpleName(),</span>
<span class="fc" id="L136">                clValue.getValue());</span>

<span class="fc" id="L138">        byte[] uIntByteArray = writeInt(clValue.getValue().intValue());</span>

<span class="fc" id="L140">        clValue.setBytes(StringByteHelper.convertBytesToHex(uIntByteArray));</span>
<span class="fc" id="L141">    }</span>

    /**
     * Writes an Integer value to byte buffer
     * 
     * @param value the value to write
     * @return byte[]
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public byte[] writeInt(Integer value) throws IOException {
<span class="fc" id="L151">        LOGGER.debug(&quot;Writing Java Type {}: {}&quot;, Integer.class.getSimpleName(), value);</span>

<span class="fc" id="L153">        ByteBuffer intByteBuffer = ByteBuffer.allocate(4).putInt(value);</span>

<span class="fc" id="L155">        byte[] intByteArray = intByteBuffer.array();</span>

<span class="fc" id="L157">        StringByteHelper.reverse(intByteArray);</span>

<span class="fc" id="L159">        this.write(intByteArray);</span>
<span class="fc" id="L160">        return intByteArray;</span>
    }

    /**
     * Writes a Long/I64 value to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueI64} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeI64(CLValueI64 clValue) throws IOException {
<span class="fc" id="L170">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.I64, Long.class.getSimpleName(),</span>
<span class="fc" id="L171">                clValue.getValue());</span>

<span class="fc" id="L173">        byte[] longByteArray = writeLong(clValue.getValue());</span>

<span class="fc" id="L175">        clValue.setBytes(StringByteHelper.convertBytesToHex(longByteArray));</span>
<span class="fc" id="L176">    }</span>

    /**
     * Writes a Long value to byte buffer
     *
     * @param value the value to write
     * @return byte[]
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public byte[] writeLong(Long value) throws IOException {
<span class="fc" id="L186">        LOGGER.debug(&quot;Writing Java Type {}: {}&quot;, Long.class.getSimpleName(), value);</span>

<span class="fc" id="L188">        ByteBuffer longByteBuffer = ByteBuffer.allocate(8).putLong(value);</span>

<span class="fc" id="L190">        byte[] longByteArray = longByteBuffer.array();</span>

<span class="fc" id="L192">        StringByteHelper.reverse(longByteArray);</span>

<span class="fc" id="L194">        this.write(longByteArray);</span>
<span class="fc" id="L195">        return longByteArray;</span>
    }

    /**
     * Writes an Unsigned Long (BigInteger)/U64 to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU64} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    public void writeU64(CLValueU64 clValue) throws IOException, CLValueEncodeException {
<span class="fc" id="L206">        checkBoundsFor(clValue.getValue(), CLTypeData.U64);</span>

<span class="fc" id="L208">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.U64, BigInteger.class.getSimpleName(),</span>
<span class="fc" id="L209">                clValue.getValue());</span>

<span class="fc" id="L211">        ByteBuffer unsignedLongByteBuffer = ByteBuffer.allocate(8).putLong(clValue.getValue().longValue());</span>

<span class="fc" id="L213">        byte[] unsignedLongByteArray = unsignedLongByteBuffer.array();</span>

<span class="fc" id="L215">        StringByteHelper.reverse(unsignedLongByteArray);</span>

<span class="fc" id="L217">        this.write(unsignedLongByteArray);</span>

<span class="fc" id="L219">        clValue.setBytes(StringByteHelper.convertBytesToHex(unsignedLongByteArray));</span>
<span class="fc" id="L220">    }</span>

    /**
     * Writes a BigInteger/U128 to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU128} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    public void writeU128(CLValueU128 clValue) throws IOException, CLValueEncodeException {
<span class="fc" id="L230">        writeBigInteger(clValue, CLTypeData.U128);</span>
<span class="fc" id="L231">    }</span>

    /**
     * Writes a BigInteger/U256 to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU256} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    public void writeU256(CLValueU256 clValue) throws IOException, CLValueEncodeException {
<span class="fc" id="L241">        writeBigInteger(clValue, CLTypeData.U256);</span>
<span class="fc" id="L242">    }</span>

    /**
     * Writes a BigInteger/U512 to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueU512} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    public void writeU512(CLValueU512 clValue) throws IOException, CLValueEncodeException {
<span class="fc" id="L252">        writeBigInteger(clValue, CLTypeData.U512);</span>
<span class="fc" id="L253">    }</span>

    /**
     * Writes a BigInteger/U128-U256-U512 to the CLValue byte buffer
     * 
     * @param clValue {@link AbstractCLValue} value to encode
     * @param type {@link CLTypeData} CLTypeData of BigInteger
     * @throws IOException thrown when an error occurs while writing bytes
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    protected void writeBigInteger(AbstractCLValue&lt;BigInteger, ?&gt; clValue, CLTypeData type)
            throws IOException, CLValueEncodeException {
<span class="fc" id="L265">        checkBoundsFor(clValue.getValue(), type);</span>

<span class="fc" id="L267">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, type.getClTypeName(), BigInteger.class.getSimpleName(),</span>
<span class="fc" id="L268">                clValue.getValue());</span>

<span class="fc" id="L270">        byte bigIntegerLength = (byte) (Math.ceil(clValue.getValue().bitLength() / 8.0));</span>
<span class="fc" id="L271">        byte[] bigIntegerBytes = writeBigInteger(clValue.getValue());</span>

<span class="fc" id="L273">        clValue.setBytes(StringByteHelper.convertBytesToHex(new byte[] { bigIntegerLength })</span>
<span class="fc" id="L274">                + StringByteHelper.convertBytesToHex(bigIntegerBytes));</span>
<span class="fc" id="L275">    }</span>

    /**
     * Writes a BigInteger to the CLValue byte buffer
     * 
     * @param bigInteger the biginteger to write
     * @return a byte array
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public byte[] writeBigInteger(BigInteger bigInteger) throws IOException {
<span class="fc" id="L285">        LOGGER.debug(&quot;Writing Java Type {}: {}&quot;, BigInteger.class.getSimpleName(), bigInteger);</span>

<span class="fc" id="L287">        byte bigIntegerLength = (byte) (Math.ceil(bigInteger.bitLength() / 8.0));</span>

<span class="fc" id="L289">        this.write(bigIntegerLength);</span>

<span class="fc" id="L291">        byte[] byteArray = bigInteger.toByteArray();</span>

        // Removing leading zeroes
<span class="fc" id="L294">        int i = 0;</span>
<span class="fc" id="L295">        boolean both = false;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">        while (byteArray[i] == 0) {</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">            if (both) {</span>
<span class="fc" id="L298">                i++;</span>
            }
<span class="fc bfc" id="L300" title="All 2 branches covered.">            both = !both;</span>
        }

<span class="fc" id="L303">        byte[] valueByteArray = Arrays.copyOfRange(byteArray, i, bigIntegerLength + i);</span>

<span class="fc" id="L305">        StringByteHelper.reverse(valueByteArray);</span>

<span class="fc" id="L307">        ByteBuffer valueByteBuffer = ByteBuffer.allocate(bigIntegerLength).put(valueByteArray);</span>

<span class="fc" id="L309">        byte[] bigIntegerBytes = valueByteBuffer.array();</span>

<span class="fc" id="L311">        this.write(bigIntegerBytes);</span>

<span class="fc" id="L313">        return bigIntegerBytes;</span>
    }

    /**
     * Writes a String/String to the CLValue byte buffer
     * 
     * @param clValue {@link CLValueString} value to encode
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public void writeString(CLValueString clValue) throws IOException {
<span class="fc" id="L323">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, CLTypeData.STRING, String.class.getSimpleName(),</span>
<span class="fc" id="L324">                clValue.getValue());</span>

<span class="fc" id="L326">        byte[] stringBytes = writeString(clValue.getValue());</span>

<span class="fc" id="L328">        clValue.setBytes(StringByteHelper.convertBytesToHex(stringBytes));</span>
<span class="fc" id="L329">    }</span>

    /**
     * Writes a String to the byte buffer
     * 
     * @param string to encode
     * @return byte[]
     * @throws IOException thrown when an error occurs while writing bytes
     */
    public byte[] writeString(String string) throws IOException {
<span class="fc" id="L339">        LOGGER.debug(&quot;Writing Java Type {}: {}&quot;, String.class.getSimpleName(), string);</span>

<span class="fc" id="L341">        ByteBuffer intByteBuffer = ByteBuffer.allocate(4).putInt(string.length());</span>

<span class="fc" id="L343">        byte[] intByteArray = intByteBuffer.array();</span>

<span class="fc" id="L345">        StringByteHelper.reverse(intByteArray);</span>

<span class="fc" id="L347">        ByteBuffer stringBuffer = ByteBuffer.allocate(4 + string.length());</span>
<span class="fc" id="L348">        stringBuffer.put(intByteArray);</span>
<span class="fc" id="L349">        stringBuffer.put(string.getBytes());</span>

<span class="fc" id="L351">        byte[] stringBytes = stringBuffer.array();</span>

<span class="fc" id="L353">        this.write(stringBytes);</span>

<span class="fc" id="L355">        return stringBytes;</span>
    }

    /**
     * Writes a AlgorithmTag/Key Hex string to CLValue byte buffer
     * 
     * @param clValue {@link CLValuePublicKey} value to encode
     */
    public void writePublicKey(CLValuePublicKey clValue) throws IOException {
<span class="fc" id="L364">        byte[] tag = new byte[] { clValue.getValue().getTag().getByteTag() };</span>
<span class="fc" id="L365">        clValue.setBytes(StringByteHelper.convertBytesToHex(tag)</span>
<span class="fc" id="L366">                + StringByteHelper.convertBytesToHex(clValue.getValue().getKey()));</span>
<span class="fc" id="L367">        this.write(tag);</span>
<span class="fc" id="L368">        this.write(clValue.getValue().getKey());</span>
<span class="fc" id="L369">    }</span>

    /**
     * Writes a Tag/Key Hex string to CLValue byte buffer
     * 
     * @param clValue {@link CLValueKey} value to encode
     */
    public void writeKey(CLValueKey clValue) {
<span class="fc" id="L377">        clValue.setBytes(StringByteHelper.convertBytesToHex(new byte[] { clValue.getValue().getTag().getByteTag() })</span>
<span class="fc" id="L378">                + StringByteHelper.convertBytesToHex(clValue.getValue().getKey()));</span>
<span class="fc" id="L379">    }</span>

    public void writeAny(CLValueAny clValue) throws IOException {
<span class="fc" id="L382">        try (ObjectOutputStream oos = new ObjectOutputStream(this)) {</span>
<span class="fc" id="L383">            oos.writeObject(clValue.getValue());</span>
        }

<span class="fc" id="L386">        clValue.setBytes(StringByteHelper.convertBytesToHex(this.toByteArray()));</span>
<span class="fc" id="L387">    }</span>

    /**
     * Checks if the value is within valid bounds for given CLType
     * 
     * @param value the value to check
     * @param type  the cltype to check against
     * @throws CLValueEncodeException thrown when a clvalue encoding throws an error
     */
    private void checkBoundsFor(BigInteger value, CLTypeData type) throws CLValueEncodeException {
        BigInteger max;
<span class="fc bfc" id="L398" title="All 2 branches covered.">        if (type.equals(CLTypeData.U64)) {</span>
<span class="fc" id="L399">            max = MAX_U64;</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">        } else if (type.equals(CLTypeData.U128)) {</span>
<span class="fc" id="L401">            max = MAX_U128;</span>
<span class="fc bfc" id="L402" title="All 2 branches covered.">        } else if (type.equals(CLTypeData.U256)) {</span>
<span class="fc" id="L403">            max = MAX_U256;</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">        } else if (type.equals(CLTypeData.U512)) {</span>
<span class="fc" id="L405">            max = MAX_U512;</span>
        } else {
<span class="nc" id="L407">            throw new CLValueEncodeException(&quot;Error checking numeric bounds&quot;, new NoSuchTypeException(</span>
<span class="nc" id="L408">                    String.format(&quot;%s is not a numeric type with check bounds for encoding&quot;, type.getClTypeName())));</span>
        }

<span class="pc bpc" id="L411" title="1 of 4 branches missed.">        if (value.compareTo(max) &gt; 0 || value.compareTo(ZERO) &lt; 0) {</span>
<span class="fc" id="L412">            throw new CLValueEncodeException(String.format(ENCODE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING,</span>
<span class="fc" id="L413">                    value, type.getClTypeName()));</span>
        }
<span class="fc" id="L415">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>